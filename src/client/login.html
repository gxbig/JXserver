<head>
    <meta charset="utf-8"/>
    <meta name="keywords"
          content="挣钱的游戏,金色传说,游戏,黄金,打工,荣耀,工会,联盟,挣钱,页游，好玩，挣钱游戏,收益,定义游戏">
    <title>金色传说游戏-登录</title>
<!--    <link rel="stylesheet" href="//unpkg.com/layui@2.6.8/dist/css/layui.css">-->
    <link rel="stylesheet" href="./layui/css/layui.css">

</head>
<body class="background">

<h3 style="color: cornflowerblue;">Golang语言社区（www.Golang.Ltd）</h3> 发送数据: <input type='text' id='name'
                                                                                        value="Leaf测试">
<input type="submit" onclick="login()"/>


<div>验证码 <span id="code"></span></div>


<!--注册弹窗-->
<form class="layui-form " id="register" style="display: none;width:425px;margin-right: 70px;padding: 40px " action="">
    <div class="layui-form-item">
        <label class="layui-form-label">邮箱地址</label>
        <div class="layui-input-block">
            <input type='text' id="email" name="email" required lay-verify="required|email" placeholder="请输入邮箱地址"
                   class="layui-input" value="18810994068@163.com">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">验证码</label>
        <div class="layui-input-inline">
            <input type='text' name="code" required lay-verify="required|code" placeholder="请输入验证码"
                   class="layui-input"
                   value="">
        </div>
        <div class=" layui-word-aux">
            <button type="button" id="getCodeButton" onclick="getCode()" class="layui-btn layui-btn-primary">
                获取验证码
            </button>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">密码</label>
        <div class="layui-input-block">
            <input type='text' id="pw" name="pw" required lay-verify="required|pw" placeholder="请输入密码" class="layui-input"
                   value="18810994068@163.com">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">确认密码</label>
        <div class="layui-input-block">
            <input type='text'  id="pwTwo"  name="pwTwo" required lay-verify="required|pwTwo" placeholder="请输入确认密码"
                   class="layui-input" value="18810994068@163.com">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block" style="margin-top: 30px">
            <button class="layui-btn" style="width:200px" lay-submit lay-filter="getCode">提交</button>
        </div>
    </div>
</form>

</body>
<script src="./jquery-3.7.0.min.js"></script>
<!--<script src="//unpkg.com/layui@2.6.8/dist/layui.js"></script>-->
<script src="./layui/layui.js"></script>
<script>
    layer.open({
        type: 1,
        title: '注册',
        content: $('#register') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
    });
    var countdown = 0//倒计时
    var time = ''

    //倒计时
    function startCountdown() {
        // 获取验证码
        countdown = 60
        countdownFunc()
        time = setInterval(function () {
            countdownFunc()
        }, 1000)
    }

    function countdownFunc() {
        if (countdown === 0) {
            clearInterval(time)
            $('#getCodeButton').text("获取验证码")
            return
        }
        $('#getCodeButton').text(countdown + "秒")
        countdown--
    }

    //获取验证码
    function getCode() {
        if (countdown > 0) return;
        let email = $('#email').val()
        if (email.search(/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/) === -1) {
            layer.msg('邮箱输入错误', {icon: 2});
            return;
        }
        startCountdown()
        $.ajax({
            url: 'http://127.0.0.1:9000/getCode',
            data: {email: email},
            method: 'get',
            error: function (err) {
                err.then(res => {
                    console.log(res, 'res')
                })
                console.log(err, 'err')
            },
            success: function (res, status) {
                if (res.code === '200') {
                    layer.msg('验证码已发送邮箱：' + email, {icon: 1});
                }
            },
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            dataType: 'json'
        });


    }


    layui.use('form', function () {
        var form = layui.form;
        //校验
        form.verify({
            code: function (value, item) { //value：表单的值、item：表单的DOM对象
                if (!new RegExp("^[0-9]+$").test(value)) {
                    return '请输入验证码！';
                }
            },
            pw: function (value, item) { //value：表单的值、item：表单的DOM对象
                if (value.trim()<=8) {
                    return '请输入最少8位密码！';
                }

            },
            pwTwo: function (value, item) { //value：表单的值、item：表单的DOM对象
                if (value.trim()<=8) {
                    return '请输入最少8位密码！';
                }
                var val = $('#pw').val()
                if(value.trim()!==val){
                    return '两次密码输入不同！';
                }
            },
        })
        //注册
        form.on('submit(getCode)', function (data) {
            $.ajax({
                url: 'http://127.0.0.1:9000/register',
                data: data.field,
                method: 'get',
                error: function (err) {
                    err.then(res => {
                        console.log(res, 'res')
                    })
                    console.log(err, 'err')
                },
                success: function (res, status) {
                    console.log(res)

                    if (res.code === '200') {
                        layer.msg('注册成功', {icon: 1});
                    }
                },
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                dataType: 'json'
            });

            return false;
        });
    });


    var wsUri = "ws://127.0.0.1:3564/?{'new':3}";
    var json;

    function login() {
        var Data = {
            LoginName: "Golang.Ltd",
            LoginPW: "123456",
        };
        var json = {
            UserLogin: Data
        }
        var goServerJson = JSON.stringify(json);
        wsUri = wsUri;
        console.log(wsUri);
        doSend(goServerJson);
    }

    "{UrN".split('').map((item, index) => {
        return String.fromCharCode(item.charCodeAt() - index - 1)
    })

    var output;
    var websocket1;

    function init() {
        output = document.getElementById("output");
        testWebSocket();
    }

    function testWebSocket() {
        console.log(wsUri)
        websocket1 = new WebSocket(wsUri);
        websocket1.onopen = function (evt) {
            onOpen(evt)
        };
        websocket1.onclose = function (evt) {
            onClose(evt)
        };
        websocket1.onmessage = function (evt) {
            onMessage(evt)
        };
        websocket1.onerror = function (evt) {
            onError(evt)
        };
    }

    function onOpen(evt) {
        console.log("CONNECTED");
    }

    function onClose(evt) {
        console.log("DISCONNECTED");
    }

    function onError(evt) {
        console.log(evt.data);
    }

    function doSend(message) {
        console.log(message);
        websocket1.send(message);
    }

    function onMessage(evt) {
        console.log(evt);
        var filrReader = new FileReader();
        filrReader.onload = function () {
            var arrayBuffer = this.result;
            var decoder = new TextDecoder('utf-8')
            var json = JSON.parse(decoder.decode(new DataView(arrayBuffer)));
            console.log(json);
        };
        filrReader.readAsArrayBuffer(evt.data);
    };
    window.addEventListener("load", init, false);
</script>
<style>
    .background {
        background: linear-gradient(to right, #68c4f3, #0e79b4);
    }

    .register {

    }
</style>