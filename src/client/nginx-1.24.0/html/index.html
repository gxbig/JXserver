<head>
    <meta charset="utf-8"/>
    <meta name="keywords"
          content="挣钱的游戏,金色传说,游戏,黄金,打工,荣耀,工会,联盟,挣钱,页游，好玩，挣钱游戏,收益,定义游戏，登录">
    <title>金色传说游戏-登录</title>
    <!--    <link rel="stylesheet" href="//unpkg.com/layui@2.6.8/dist/css/layui.css">-->
    <link rel="stylesheet" href="./css/normalize.css">
    <link rel="stylesheet" href="./layui/css/layui.css">
</head>
<body class="background">
<!--登录-->
<div class="login-wrap">
    <div>登录</div>
    <form class="layui-form " id="login" style="width:425px;margin-right: 70px;padding: 40px " action="">
        <div class="layui-form-item">
            <label class="layui-form-label">邮箱地址</label>
            <div class="layui-input-block">
                <input type='text' id="loginEmail" name="email" required lay-verify="required|email"
                       placeholder="请输入邮箱地址"
                       class="layui-input" value="18810994068@163.com">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">密码</label>
            <div class="layui-input-block">
                <input type='text' id="loginPw" name="pw" required lay-verify="required|pw" placeholder="请输入密码"
                       class="layui-input"
                       value="18810994068@163.com">
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block" style="margin-top: 30px">
                <button class="layui-btn" style="width:200px" lay-submit lay-filter="login">提交</button>
            </div>
        </div>
    </form>
    <div>
        <button class="layui-btn" onClick="openR()">注册</button>
        <button class="layui-btn" onClick="resetPw()">重置密码</button>
    </div>
</div>

<!--注册弹窗-->
<form class="layui-form " id="register" style="display: none;width:425px;margin-right: 70px;padding: 40px " action="">
    <div class="layui-form-item">
        <label class="layui-form-label">邮箱地址</label>
        <div class="layui-input-block">
            <input type='text' id="email" name="email" required lay-verify="required|email" placeholder="请输入邮箱地址"
                   class="layui-input" value="18810994068@163.com">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">验证码</label>
        <div class="layui-input-inline">
            <input type='text' name="code" id="registerCode" required lay-verify="required|code"
                   placeholder="请输入验证码"
                   class="layui-input"
                   value="">
        </div>
        <div class=" layui-word-aux">
            <button type="button" id="getCodeButton" onclick="getCode()" class="layui-btn layui-btn-primary">
                获取验证码
            </button>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">密码</label>
        <div class="layui-input-block">
            <input type='text' id="pw" name="pw" required lay-verify="required|pw" placeholder="请输入密码"
                   class="layui-input"
                   value="18810994068@163.com">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">确认密码</label>
        <div class="layui-input-block">
            <input type='text' id="pwTwo" name="pwTwo" required lay-verify="required|pwTwo" placeholder="请输入确认密码"
                   class="layui-input" value="18810994068@163.com">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block" style="margin-top: 30px">
            <button class="layui-btn" style="width:200px" lay-submit lay-filter="register">提交</button>
        </div>
    </div>
</form>
<!--重置密码弹窗-->
<form class="layui-form " id="resetPwModal" style="display: none;width:425px;margin-right: 70px;padding: 40px "
      action="">
    <div class="layui-form-item">
        <label class="layui-form-label">邮箱地址</label>
        <div class="layui-input-block">
            <input type='text' id="resetPw-email" name="email" required lay-verify="required|email"
                   placeholder="请输入邮箱地址"
                   class="layui-input" value="">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">验证码</label>
        <div class="layui-input-inline">
            <input type='text' name="code" id="resetPwModalCode" required lay-verify="required|code"
                   placeholder="请输入验证码"
                   class="layui-input"
                   value="">
        </div>
        <div class=" layui-word-aux">
            <button type="button" id="resetPw-getCodeButton" onclick="getCode()" class="layui-btn layui-btn-primary">
                获取验证码
            </button>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">密码</label>
        <div class="layui-input-block">
            <input type='text' id="resetPw" name="pw" required lay-verify="required|pw" placeholder="请输入密码"
                   class="layui-input"
                   value="">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">确认密码</label>
        <div class="layui-input-block">
            <input type='text' id="resetPwTwo" name="pwTwo" required lay-verify="required|resetPwTwo"
                   placeholder="请输入确认密码"
                   class="layui-input" value="">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block" style="margin-top: 30px">
            <button class="layui-btn" style="width:200px" lay-submit lay-filter="resetPw">提交</button>
        </div>
    </div>
</form>

</body>
<script src="./jquery-3.7.0.min.js"></script>
<script src="./cdn.staticfile.org_jquery-cookie_1.4.1_jquery.cookie.min.js"></script>
<!--<script src="//unpkg.com/layui@2.6.8/dist/layui.js"></script>-->
<script src="./layui/layui.js"></script>
<script>

    var dev = true
    var url = "http://localhost:9000"
    var loading =''
    var pageType = ""
    var countdown = 0//倒计时
    var time = ''
    var layerIndex = 0

    function startLoading(){
        loading= layer.load('Loading...', {
            shade: [0.1,'#fff'] //0.1透明度的白色背景
        });
    }
    function closeLoading(){
        layer.close(loading);
    }
    //初始
    //校验session是否合法
    if($.cookie("sessionId")){
        getUser()
    }else {
        $.cookie("serverO",'')
        window.localStorage.setItem('userInfo',undefined)
    }

    //获取人员信息
    function getUser() {
        startLoading()
        $.ajax({
            url: url + '/getUser',
            method: 'get',
            error: function (err) {
                closeLoading()
                layer.msg('服务器异常！', {icon: 2});
            },
            success: function (res, status) {
                closeLoading()
                if (res.code === '200') {
                    //获取
                    window.localStorage.setItem('userInfo',JSON.stringify(res.data))
                    if($.cookie("serverO")){
                        window.location.href='/game.html'
                    }else {
                        window.location.href='/selectSever.html'
                    }
                } else if (res.code === '502') {

                } else {
                    layer.msg(res.data || res.message, {icon: 2});
                }
            },
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                "token": $.cookie("sessionId")
            },
            dataType: 'json'
        });
    }



    //打开注册页面
    function openR() {
        if (!dev) {
            $('#registerCode').val('')
            $('#email').val('')
            $('#pwTwo').val('')
            $('#pw').val('')
        }

        countdown = 0
        pageType = "register"
        layerIndex = layer.open({
            type: 1,
            title: '注册',
            content: $('#register') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
        });
    }

    //打开重置密码页面
    function resetPw() {
        if (!dev) {
            $('#resetPw-email').val('')
            $('#resetPwModalCode').val('')
            $('#resetPw').val('')
            $('#resetPwTwo').val('')
        }else {
            $('#resetPw-email').val('18810994068@163.com')
            $('#resetPwModalCode').val('')
            $('#resetPw').val('18810994068@163.com')
            $('#resetPwTwo').val('18810994068@163.com')
        }
        countdown = 0
        pageType = "resetPw"
        layerIndex = layer.open({
            type: 1,
            title: '重置密码',
            content: $('#resetPwModal') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
        });
    }


    //倒计时
    function startCountdown() {
        // 获取验证码
        clearInterval(time)
        countdown = 60
        countdownFunc()
        time = setInterval(function () {
            countdownFunc()
        }, 1000)
    }

    function countdownFunc() {
        if (countdown <= 0) {
            clearInterval(time)
            $('#getCodeButton').text("获取验证码")
            return
        }
        $('#getCodeButton').text(countdown + "秒")
        countdown--
    }

    //获取验证码
    function getCode() {
        if (countdown > 0) return;
        let email = pageType === "register" ? $('#email').val() : $('#resetPw-email').val()
        console.log(email)
        if (email.search(/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/) === -1) {
            layer.msg('邮箱输入错误', {icon: 2});
            return;
        }
        startCountdown()
        $.ajax({
            url: url + '/getCode',
            data: {email: email},
            method: 'get',
            error: function (err) {

            },
            success: function (res, status) {
                if (res.code === '200') {
                    layer.msg('验证码已发送邮箱：' + email, {icon: 1});
                } else {
                    layer.msg(res.data || res.message, {icon: 2});
                    clearInterval(time)
                    countdown = 0
                    $('#getCodeButton').text("获取验证码")
                }
            },
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            dataType: 'json'
        });


    }


    //增加校验
    layui.use('form', function () {
        var form = layui.form;
        //校验
        form.verify({
            code: function (value, item) { //value：表单的值、item：表单的DOM对象
                if (!new RegExp("^[0-9]+$").test(value)) {
                    return '请输入正确验证码！';
                }
            },
            pw: function (value, item) { //value：表单的值、item：表单的DOM对象
                if (value.trim() <= 8) {
                    return '请输入最少8位密码！';
                }

            },
            pwTwo: function (value, item) { //value：表单的值、item：表单的DOM对象
                if (value.trim() <= 8) {
                    return '请输入最少8位密码！';
                }
                var val = $('#pw').val()
                if (value.trim() !== val) {
                    return '两次密码输入不同！';
                }
            },
            resetPwTwo: function (value, item) { //value：表单的值、item：表单的DOM对象
                if (value.trim() <= 8) {
                    return '请输入最少8位密码！';
                }

                var val = $('#resetPw').val()

                if (value.trim() !== val) {
                    return '两次密码输入不同！';
                }
            },
        })
        //注册
        form.on('submit(register)', function (data) {
            startLoading()
            $.ajax({
                url: url + '/register',
                data: data.field,
                method: 'post',
                error: function (err) {

                    closeLoading()
                },
                success: function (res, status) {
                    closeLoading()

                    if (res.code === '200') {
                        layer.msg('注册成功', {icon: 1});
                        //设置cookie
                        $.cookie("sessionId", res.data, {expires: 30})
                        getUser()
                        countdown = 0
                        layer.close(layerIndex)
                    } else {
                        layer.msg(res.data || res.message, {icon: 2});
                    }
                },
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                dataType: 'json'
            });

            return false;
        });

        //登录
        form.on('submit(login)', function (data) {
            console.log(1)

            startLoading()
            $.ajax({
                url: url + '/login',
                data: data.field,
                method: 'post',
                error: function (err) {
                    closeLoading()
                },
                success: function (res, status) {
                    closeLoading()
                    if (res.code === '200') {
                        layer.msg('登录成功', {icon: 1});
                        //设置cookie
                        countdown = 0
                        $.cookie("sessionId", res.data, {expires: 30})
                        window.location.href='/selectSever.html'
                    } else {
                        layer.msg(res.data || res.message, {icon: 2});
                    }
                },
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    "token": $.cookie("sessionId")
                },
                dataType: 'json'
            });

            return false;
        });
        //重置密码
        form.on('submit(resetPw)', function (data) {

            startLoading()
            $.ajax({
                url: url + '/resetPassword',
                data: data.field,
                method: 'post',
                error: function (err) {
                    closeLoading()
                },
                success: function (res, status) {
                    closeLoading()
                    if (res.code === '200') {
                        layer.msg('重置密码成功，请重新登录', {icon: 1});
                        layer.close(layerIndex)
                        countdown = 0
                    } else {
                        layer.msg(res.data || res.message, {icon: 2});
                    }
                },
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                dataType: 'json'
            });

            return false;
        });
    });


    var wsUri = "ws://127.0.0.1:3564/?{'new':3}";
    var json;
   

    function login1() {
        var Data = {
            LoginName: "Golang.Ltd",
            LoginPW: "123456",
        };
        var json = {
            UserLogin: Data
        }
        var goServerJson = JSON.stringify(json);


        doSend(goServerJson);

        var Data1 = {
            Name: "Golang.Ltd",

        };
        var json1 = {
            Hello: Data1
        }
        var goServerJson1 = JSON.stringify(json1);


        doSend(goServerJson1);
    }



    var output;
    var websocket1;

    function init() {
        testWebSocket();
    }

    function testWebSocket() {
        console.log(wsUri)
        websocket1 = new WebSocket(wsUri);
        websocket1.onopen = function (evt) {
            onOpen(evt)
        };
        websocket1.onclose = function (evt) {
            onClose(evt)
        };
        websocket1.onmessage = function (evt) {
            onMessage(evt)
        };
        websocket1.onerror = function (evt) {
            onError(evt)
        };
    }

    function onOpen(evt) {
        console.log("CONNECTED");
        login1()
    }

    function onClose(evt) {
        console.log("DISCONNECTED");
    }

    function onError(evt) {
        console.log(evt.data);
    }

    function doSend(message) {
        console.log(message);
        websocket1.send(message);
    }

    function onMessage(evt) {
        console.log(evt);
        var filrReader = new FileReader();
        filrReader.onload = function () {
            var arrayBuffer = this.result;
            var decoder = new TextDecoder('utf-8')
            var json = JSON.parse(decoder.decode(new DataView(arrayBuffer)));
            console.log(json);
        };
        filrReader.readAsArrayBuffer(evt.data);
    };
    window.addEventListener("load", init, false);
</script>
<style>
    .background {
        background: linear-gradient(to right, #68c4f3, #0e79b4);
    }

    .login-wrap {
        background: #fff;
        position: absolute;
        left: 50%;
        right: 50%;
        top: 50%;
        bottom: 50%;
        margin: -200px 0 0 -300px;
        width: 600px;
        height: 400px;
    }

    .register {

    }
</style>